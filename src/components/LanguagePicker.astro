---
import { languages } from '../i18n/ui';
import { getLangFromUrl } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;

function getPathForLang(targetLang: string) {
  if (targetLang === lang) return currentPath;
  
  // Удаляем префикс текущего языка
  let basePath = currentPath;
  if (lang === 'en') {
    basePath = currentPath.replace(/^\/en/, '') || '/';
  }
  
  // Добавляем префикс нового языка
  if (targetLang === 'en') {
    return `/en${basePath}`;
  }
  
  return basePath;
}
---

<div class="relative inline-block text-left lang-picker">
  <button
    type="button"
    class="lang-picker-button inline-flex items-center gap-2 px-3 py-2 text-sm rounded hover:bg-[var(--color-bg-secondary)] transition-colors"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <span>{languages[lang]}</span>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <div
    class="lang-picker-menu hidden absolute right-0 mt-2 w-32 rounded bg-[var(--color-bg-secondary)] border border-[var(--color-border)] shadow-lg z-50"
    role="menu"
    aria-orientation="vertical"
  >
    {Object.entries(languages).map(([code, name]) => (
      <a
        href={getPathForLang(code)}
        class:list={[
          'block px-4 py-2 text-sm hover:bg-primary-600 hover:text-white transition-colors first:rounded-t last:rounded-b',
          lang === code && 'bg-primary-600 text-white'
        ]}
        role="menuitem"
      >
        {name}
      </a>
    ))}
  </div>
</div>

<script>
  // Handle all language picker instances
  document.querySelectorAll('.lang-picker').forEach(picker => {
    const button = picker.querySelector('.lang-picker-button');
    const menu = picker.querySelector('.lang-picker-menu');

    if (button && menu) {
      button.addEventListener('click', (e) => {
        e.stopPropagation();
        const isExpanded = button.getAttribute('aria-expanded') === 'true';
        
        // Close all other language pickers
        document.querySelectorAll('.lang-picker').forEach(otherPicker => {
          if (otherPicker !== picker) {
            const otherButton = otherPicker.querySelector('.lang-picker-button');
            const otherMenu = otherPicker.querySelector('.lang-picker-menu');
            if (otherButton && otherMenu) {
              otherButton.setAttribute('aria-expanded', 'false');
              otherMenu.classList.add('hidden');
            }
          }
        });
        
        // Toggle this picker
        button.setAttribute('aria-expanded', String(!isExpanded));
        menu.classList.toggle('hidden');
      });

      // Close when clicking outside
      document.addEventListener('click', (e) => {
        const target = e.target as Node;
        if (!picker.contains(target)) {
          button.setAttribute('aria-expanded', 'false');
          menu.classList.add('hidden');
        }
      });
    }
  });
</script>
