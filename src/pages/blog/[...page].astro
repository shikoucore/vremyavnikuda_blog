---
import BaseLayout from '@layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../../i18n/utils';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths = (async ({ paginate }) => {
  const allPosts = (await getCollection('blog'))
    .filter(post => !post.data.draft)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  const jaPostsPages = paginate(
    allPosts.filter(post => post.data.lang === 'ja'),
    { pageSize: 10 }
  );

  const enPostsPages = paginate(
    allPosts.filter(post => post.data.lang === 'en'),
    { pageSize: 10 }
  );

  return [
    ...jaPostsPages.map(page => ({ ...page, params: { ...page.params, page: page.params.page || '1' } })),
    ...enPostsPages.map(page => ({ ...page, params: { ...page.params, page: `en/${page.params.page || '1'}` } }))
  ];
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<BaseLayout title={`${t('blog.title')} - vremyavnikuda`} description={t('blog.description')}>
  <div class="max-w-4xl mx-auto px-4 py-16">
    <header class="mb-12">
      <h1 class="text-4xl font-bold mb-4">{t('blog.title')}</h1>
      <p class="text-xl text-[var(--color-text-secondary)]">
        {t('blog.description')}
      </p>
    </header>

    {page.data.length === 0 ? (
      <p class="text-[var(--color-text-secondary)]">{t('blog.noPosts')}</p>
    ) : (
      <>
        <div class="space-y-12">
          {page.data.map((post) => (
            <article class="group">
              <a href={getLocalizedPath(`/blog/${post.slug}`, lang)} class="block">
                <time class="text-sm text-[var(--color-text-secondary)]">
                  {post.data.pubDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                </time>
                <h2 class="text-3xl font-semibold mt-2 mb-3 group-hover:text-primary-400 transition-colors">
                  {post.data.title}
                </h2>
                <p class="text-[var(--color-text-secondary)] mb-4">
                  {post.data.description}
                </p>
                {post.data.tags.length > 0 && (
                  <div class="flex gap-2">
                    {post.data.tags.map((tag) => (
                      <span class="text-xs px-2 py-1 bg-[var(--color-bg-secondary)] rounded">
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
              </a>
            </article>
          ))}
        </div>

        {/* Pagination */}
        {(page.lastPage > 1) && (
          <nav class="flex justify-center items-center gap-4 mt-12">
            {page.url.prev && (
              <a
                href={page.url.prev}
                class="px-4 py-2 border border-[var(--color-border)] rounded hover:bg-[var(--color-bg-secondary)] transition-colors"
              >
                {t('pagination.previous')}
              </a>
            )}
            
            <span class="text-[var(--color-text-secondary)]">
              {t('pagination.page')} {page.currentPage} {t('pagination.of')} {page.lastPage}
            </span>

            {page.url.next && (
              <a
                href={page.url.next}
                class="px-4 py-2 border border-[var(--color-border)] rounded hover:bg-[var(--color-bg-secondary)] transition-colors"
              >
                {t('pagination.next')}
              </a>
            )}
          </nav>
        )}
      </>
    )}
  </div>
</BaseLayout>
